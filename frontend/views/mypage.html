<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚¤ãƒšãƒ¼ã‚¸ - Stripe Gym</title>
    <link rel="stylesheet" href="../styles/styles.css?v=20241220">
</head>

<body>
    <div class="container">
        <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
        <div class="nav-buttons">
            <div class="nav-section">
                <button onclick="window.location.href='home.html'" class="nav-button home-button">
                    ãƒ›ãƒ¼ãƒ 
                </button>
                <button onclick="logout()" class="nav-button logout-button">
                    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </button>
            </div>
        </div>

        <div class="logo">ğŸ’ª Stripe Gym</div>
        <p class="subtitle">ãƒã‚¤ãƒšãƒ¼ã‚¸</p>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="user-info-section">
            <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h2>
            <div class="user-details">
                <div class="user-detail-item">
                    <span class="label">ãŠåå‰:</span>
                    <span id="user-name" class="value">-</span>
                </div>
                <div class="user-detail-item">
                    <span class="label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:</span>
                    <span id="user-email" class="value">-</span>
                </div>
                <div class="user-detail-item">
                    <span class="label">é›»è©±ç•ªå·:</span>
                    <span id="user-phone" class="value">-</span>
                </div>
                <div class="user-detail-item">
                    <span class="label">ç”Ÿå¹´æœˆæ—¥:</span>
                    <span id="user-birthdate" class="value">-</span>
                </div>
                <div class="user-detail-item">
                    <span class="label">ä¼šå“¡ç™»éŒ²æ—¥:</span>
                    <span id="user-created" class="value">-</span>
                </div>
            </div>
        </div>

        <!-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ -->
        <div class="subscription-section">
            <h2>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³</h2>
            <div id="active-subscription" class="subscription-card">
                <div class="no-data">ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“</div>
            </div>
        </div>

        <!-- è³¼å…¥å±¥æ­´ -->
        <div class="purchase-history-section">
            <h2>è³¼å…¥å±¥æ­´</h2>
            <div id="purchase-history" class="history-list">
                <div class="no-data">è³¼å…¥å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>
            </div>
        </div>

        <!-- ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å±¥æ­´ -->
        <div class="subscription-history-section">
            <h2>ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å±¥æ­´</h2>
            <div id="subscription-history" class="history-list">
                <div class="no-data">ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>
            </div>
        </div>
    </div>

    <script src="../js/config.js?v=20241220"></script>
    <script src="../js/app.js?v=20241220" defer></script>

    <script>
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            loadUserData();
        });

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        function loadUserData() {
            const sessionToken = localStorage.getItem('session_token');
            
            if (!sessionToken) {
                alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                window.location.href = 'login.html';
                return;
            }

            // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼
            fetch(window.AppConfig.api.baseUrl + '/api/verify-session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_token: sessionToken })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
                    displayUserInfo(data.user_id);
                    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—
                    loadActiveSubscription(data.user_id);
                    // è³¼å…¥å±¥æ­´ã‚’å–å¾—
                    loadPurchaseHistory(data.user_id);
                    // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å±¥æ­´ã‚’å–å¾—
                    loadSubscriptionHistory(data.user_id);
                } else {
                    alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç„¡åŠ¹ã§ã™');
                    window.location.href = 'login.html';
                }
            })
            .catch(error => {
                console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                window.location.href = 'login.html';
            });
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
        function displayUserInfo(userId) {
            // APIã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
            fetch(window.AppConfig.api.baseUrl + '/api/user-info', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const user = data.user;
                    document.getElementById('user-name').textContent = user.name || '-';
                    document.getElementById('user-email').textContent = user.email || '-';
                    document.getElementById('user-phone').textContent = user.phone || '-';
                    document.getElementById('user-birthdate').textContent = user.birthdate || '-';
                    document.getElementById('user-created').textContent = user.created_at ? new Date(user.created_at).toLocaleDateString('ja-JP') : '-';
                } else {
                    // APIã‹ã‚‰å–å¾—ã§ããªã„å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰è¡¨ç¤º
                    const userName = localStorage.getItem('user_name');
                    const userEmail = localStorage.getItem('user_email');
                    
                    document.getElementById('user-name').textContent = userName || '-';
                    document.getElementById('user-email').textContent = userEmail || '-';
                    document.getElementById('user-phone').textContent = '-';
                    document.getElementById('user-birthdate').textContent = '-';
                    document.getElementById('user-created').textContent = new Date().toLocaleDateString('ja-JP');
                }
            })
            .catch(error => {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰è¡¨ç¤º
                const userName = localStorage.getItem('user_name');
                const userEmail = localStorage.getItem('user_email');
                
                document.getElementById('user-name').textContent = userName || '-';
                document.getElementById('user-email').textContent = userEmail || '-';
                document.getElementById('user-phone').textContent = '-';
                document.getElementById('user-birthdate').textContent = '-';
                document.getElementById('user-created').textContent = new Date().toLocaleDateString('ja-JP');
            });
        }

        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿
        function loadActiveSubscription(userId) {
            fetch(window.AppConfig.api.baseUrl + '/api/user-subscription-history', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId })
            })
            .then(response => response.json())
            .then(data => {
                const activeContainer = document.getElementById('active-subscription');
                
                if (data.success && data.subscriptions && data.subscriptions.length > 0) {
                    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ¢ã™
                    const activeSubscription = data.subscriptions.find(sub => sub.status === 'active');
                    
                    if (activeSubscription) {
                        activeContainer.innerHTML = `
                            <div class="history-item">
                                <div class="history-item-info">
                                    <div class="history-item-details">
                                        <div class="history-item-title">${activeSubscription.plan_name || activeSubscription.price_id || 'ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³'}</div>
                                        <div class="history-item-date">${new Date(activeSubscription.created_at).toLocaleDateString('ja-JP')}</div>
                                    </div>
                                    <div class="history-item-status status-active">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</div>
                                </div>
                                <div class="history-item-actions">
                                    <button class="cancel-subscription-button" onclick="cancelSubscription('${activeSubscription.id}')">
                                        è§£ç´„ã™ã‚‹
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        activeContainer.innerHTML = '<div class="no-data">ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                    }
                } else {
                    activeContainer.innerHTML = '<div class="no-data">ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                }
            })
            .catch(error => {
                console.error('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                const activeContainer = document.getElementById('active-subscription');
                activeContainer.innerHTML = '<div class="no-data">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            });
        }

        // è³¼å…¥å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
        function loadPurchaseHistory(userId) {
            fetch(window.AppConfig.api.baseUrl + '/api/user-purchase-history', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId })
            })
            .then(response => response.json())
            .then(data => {
                const historyContainer = document.getElementById('purchase-history');
                
                if (data.success && data.purchases && data.purchases.length > 0) {
                    historyContainer.innerHTML = data.purchases.map(purchase => `
                        <div class="history-item">
                            <div class="history-item-info">
                                <div class="history-item-details">
                                    <div class="history-item-title">${purchase.product_name || 'å•†å“'}</div>
                                    <div class="history-item-date">${new Date(purchase.created_at).toLocaleDateString('ja-JP')}</div>
                                </div>
                                <div class="history-item-status status-completed">å®Œäº†</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    historyContainer.innerHTML = '<div class="no-data">è³¼å…¥å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                }
            })
            .catch(error => {
                console.error('è³¼å…¥å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                const historyContainer = document.getElementById('purchase-history');
                historyContainer.innerHTML = '<div class="no-data">è³¼å…¥å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            });
        }

        // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
        function loadSubscriptionHistory(userId) {
            fetch(window.AppConfig.api.baseUrl + '/api/user-subscription-history', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId })
            })
            .then(response => response.json())
            .then(data => {
                const historyContainer = document.getElementById('subscription-history');
                
                if (data.success && data.subscriptions && data.subscriptions.length > 0) {
                    historyContainer.innerHTML = data.subscriptions.map(subscription => `
                        <div class="history-item">
                            <div class="history-item-info">
                                <div class="history-item-details">
                                    <div class="history-item-title">${subscription.plan_name || subscription.price_id || 'ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³'}</div>
                                    <div class="history-item-date">${new Date(subscription.created_at).toLocaleDateString('ja-JP')}</div>
                                </div>
                                <div class="history-item-status ${subscription.status === 'active' ? 'status-active' : 'status-cancelled'}">
                                    ${subscription.status === 'active' ? 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' : 
                                      subscription.status === 'canceled' ? 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿' : 
                                      subscription.status === 'cancelled' ? 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿' : 
                                      subscription.status || 'ä¸æ˜'}
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    historyContainer.innerHTML = '<div class="no-data">ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                }
            })
            .catch(error => {
                console.error('ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                const historyContainer = document.getElementById('subscription-history');
                historyContainer.innerHTML = '<div class="no-data">ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            });
        }

        // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³è§£ç´„å‡¦ç†
        function cancelSubscription(subscriptionId) {
            if (!confirm('ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’è§£ç´„ã—ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®æœŸé–“çµ‚äº†æ™‚ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã™ã€‚')) {
                return;
            }

            const sessionToken = localStorage.getItem('session_token');
            
            if (!sessionToken) {
                alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                window.location.href = 'login.html';
                return;
            }

            // è§£ç´„ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            const cancelButton = event.target;
            const originalText = cancelButton.textContent;
            cancelButton.disabled = true;
            cancelButton.textContent = 'å‡¦ç†ä¸­...';

            fetch(window.AppConfig.api.baseUrl + '/api/cancel-subscription', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${sessionToken}`
                },
                body: JSON.stringify({ subscription_id: subscriptionId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message || 'ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®è§£ç´„ãŒå®Œäº†ã—ã¾ã—ãŸ');
                    // ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦æœ€æ–°ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
                    location.reload();
                } else {
                    alert(data.error || 'è§£ç´„å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                    // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                    cancelButton.disabled = false;
                    cancelButton.textContent = originalText;
                }
            })
            .catch(error => {
                console.error('è§£ç´„ã‚¨ãƒ©ãƒ¼:', error);
                alert('è§£ç´„å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                cancelButton.disabled = false;
                cancelButton.textContent = originalText;
            });
        }
    </script>
</body>

</html>
