<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stripe Gym - フィットネス会員プラン</title>
    <link rel="stylesheet" href="../styles/styles.css">
</head>

<body>
    <div class="container">
        <!-- ナビゲーションボタン -->
        <div class="nav-buttons">
            <!-- 未ログイン時 -->
            <div id="guest-nav" class="nav-section">
                <button onclick="window.location.href='user-registration.html'"
                    class="nav-button register-button">
                    新規会員登録
                </button>
                <button onclick="window.location.href='login.html'" class="nav-button login-button">
                    ログイン
                </button>
            </div>

            <!-- ログイン時 -->
            <div id="user-nav" class="nav-section" style="display: none;">
                <span id="user-name" class="user-info"></span>
                <button onclick="window.location.href='mypage.html'" class="nav-button mypage-button">
                    マイページ
                </button>
                <button onclick="logout()" class="nav-button logout-button">
                    ログアウト
                </button>
            </div>
        </div>

        <div class="logo">💪 Stripe Gym</div>
        <p class="subtitle">あなたのフィットネスライフを始めましょう</p>

        <div class="plan-cards-container">
            <div class="plan-card">
                <h2 class="plan-title">スタンダードプラン</h2>
                <div class="plan-price">¥5,800</div>
                <div class="plan-period">月額</div>

                <ul class="features">
                    <li>平日7:00-22:00アクセス</li>
                    <li>基本設備利用可能</li>
                    <li>グループレッスン（月4回）</li>
                    <li>ロッカールーム利用</li>
                    <li>シャワールーム利用</li>
                    <li>オンラインサポート</li>
                </ul>

                <button id="standard-subscription-button" class="subscription-button">
                    今すぐ始める
                </button>

                <div class="loading" id="loading-standard">
                    処理中...
                </div>

                <div class="error" id="error-standard"></div>
            </div>

            <div class="plan-card premium-card">
                <h2 class="plan-title">プレミアムプラン</h2>
                <div class="plan-price">¥9,800</div>
                <div class="plan-period">月額</div>

                <ul class="features">
                    <li>24時間アクセス可能</li>
                    <li>全設備利用可能</li>
                    <li>パーソナルトレーニング（月2回）</li>
                    <li>栄養指導サービス</li>
                    <li>グループレッスン無制限</li>
                    <li>ロッカールーム利用</li>
                </ul>

                <button id="subscription-button" class="subscription-button">
                    今すぐ始める
                </button>

                <div class="loading" id="loading">
                    処理中...
                </div>

                <div class="error" id="error"></div>
            </div>

            <div class="plan-card">
                <h2 class="plan-title">オリジナルプロテイン</h2>
                <div class="plan-price">¥4,980</div>
                <div class="plan-period">1袋（500g）</div>

                <ul class="features">
                    <li>高品質ホエイプロテイン</li>
                    <li>無添加・無香料</li>
                    <li>1食分25gのタンパク質含有</li>
                    <li>20食分入り</li>
                    <li>即日配送対応</li>
                    <li>30日間返金保証</li>
                </ul>

                <button id="checkout-button" class="checkout-button">
                    今すぐ購入
                </button>

                <div class="loading" id="loading-product">
                    処理中...
                </div>

                <div class="error" id="error-product"></div>
            </div>
        </div>

        <div class="footer">
            <p>安全で確実な決済処理をStripeが提供します</p>
        </div>
    </div>

    <script src="../js/config.js?v=20241220"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="../js/app.js?v=20241220" defer></script>
    
    <script>
        // ページ読み込み時にアクティブサブスクリプションをチェック
        document.addEventListener('DOMContentLoaded', function() {
            checkActiveSubscriptions();
        });

        // アクティブサブスクリプションをチェックしてUIを更新
        function checkActiveSubscriptions() {
            const sessionToken = localStorage.getItem('session_token');
            
            if (!sessionToken) {
                return; // 未ログインの場合は何もしない
            }

            // セッション検証
            fetch(window.AppConfig.api.baseUrl + '/api/verify-session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_token: sessionToken })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // アクティブサブスクリプションを取得
                    fetch(window.AppConfig.api.baseUrl + '/api/user-active-subscriptions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: data.user_id })
                    })
                    .then(response => response.json())
                    .then(subData => {
                        if (subData.success) {
                            updatePlanButtons(subData);
                        }
                    })
                    .catch(error => {
                        console.error('アクティブサブスクリプション取得エラー:', error);
                    });
                }
            })
            .catch(error => {
                console.error('セッション確認エラー:', error);
            });
        }

        // プランボタンの状態を更新
        function updatePlanButtons(subscriptionData) {
            const standardButton = document.getElementById('standard-subscription-button');
            const premiumButton = document.getElementById('subscription-button');

            // スタンダードプランがアクティブな場合
            if (subscriptionData.has_standard) {
                standardButton.textContent = '利用中（アクティブ）';
                standardButton.disabled = true;
                standardButton.classList.add('active-plan-button');
            }

            // プレミアムプランがアクティブな場合
            if (subscriptionData.has_premium) {
                premiumButton.textContent = '利用中（アクティブ）';
                premiumButton.disabled = true;
                premiumButton.classList.add('active-plan-button');
            }
        }
    </script>
</body>

</html>